#!/usr/bin/python
# -*- coding: utf-8 -*-

import mechanize
from calibre.web.feeds.news import BasicNewsRecipe

class AdvancedUserRecipeMineTest(BasicNewsRecipe):

  title          = u'寻找太阳系的疆界'
  INDEX = 'http://www.changhai.org/articles/science/astronomy/outer_planets/'
  #title = u'太阳的故事'
  #INDEX = 'http://www.changhai.org/articles/science/astronomy/sun/index.php'
  
  __author__ = u'卢昌海'
  __version__ = '1.0'
  language = 'zh-CN'
  pubisher = '卢昌海'
  description = u''
  category = 'Science, Chinese'
  remove_javascript = True
  use_embedded_content = False
  no_stylesheets = True
  encoding = 'UTF-8'
  conversion_options = {'linearize_tables':True}
  keep_only_tags = [
    dict(name='table', attrs={'id':['main-body']}),
  ]

#    remove_tags = [
#        dict(name='span', attrs={'class':['xl1_elp','midBlock','rightBorder']}),
      #dict(name='div', attrs={'class':['topnav']}),
#        ]

  '''
  def get_browser(self):
      br = BasicNewsRecipe.get_browser(self)
      br.set_handle_referer(True)
      br.set_debug_http(True)
      return br
  '''

  '''
  def get_browser(self):
    print "==================MINEDBG1====================="    
    br = BasicNewsRecipe.get_browser(self)
    orig_open_novisit = br.open_novisit

    def my_open_no_visit(url, **kwargs):
      print "==================MINEDBG2====================="
      req = mechanize.Request(url, headers = {'Referer': self.INDEX + "02.php"})
      return orig_open_novisit(req)

    br.open_novisit = my_open_no_visit
    br.set_debug_http(True)
    #br.open(self.INDEX)
    print br
    print br.open_novisit
    return br
  '''

  def get_browser(self):
    print "==================MINEDBG1====================="    
    br = BasicNewsRecipe.get_browser(self)
    orig_open_novisit = br.open_novisit
    def my_open_no_visit(url, **kwargs):
      print "==================MINEDBG2====================="
      req = mechanize.Request( url, headers = { 'Referer': self.INDEX, })
      return orig_open_novisit(req)
    br.open_novisit = my_open_no_visit
    print br
    print id(br)
    print br.open_novisit
    br.set_debug_http(True)
    return br

  '''
  def get_browser(self):
    br = BasicNewsRecipe.get_browser(self)
    req = mechanize.Request(
      self.INDEX,
      headers = {
      'Referer': self.INDEX,
      })
    br.set_debug_http(True)
    br.open(req).read()
    return br
  '''

  # TODO： override clone_browser()
  # TODO: 术语简介 etc
  def parse_index(self):
    print "MINEDBG"
    articles = []
    feeds = []

    soup = self.index_to_soup(self.INDEX)    
    feed_title = self.tag_to_string(soup.find('title'))
    print "MINEDBG: feed_title: "
    print feed_title
    for table in soup.findAll('table', attrs={'class':'inside-article-noborder'}):
      #print "MINEDBG: table:"
      print table

      for post in table.findAll('td'):
        #print "MINEDBG: post:"
        print post
        a = post.find('a', href=True)
        title = self.tag_to_string(post)
        url = a['href']
        if "#" not in url:
          print "MINEDBG: title and url:"
          print title + ": " + url
          url = self.INDEX + url
          articles.append(({'title':title, 'url':url, 'description':'',
                'date':''}))
    if articles:
      feeds.append((feed_title, articles))
    print feeds
    return feeds


